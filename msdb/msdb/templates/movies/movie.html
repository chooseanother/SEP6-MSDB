{% extends "base.html" %}
{% load static i18n compress%}

<style>
  a {
    text-decoration: none !important;
  }
</style>

{% block content %}
<h1>{{ movie_datab.title }}</h1>
<p>{{ movie_datab.year }}&nbsp;&nbsp;&nbsp; - &nbsp;&nbsp;&nbsp; {{ movie_api.rated}} &nbsp;&nbsp;&nbsp; - &nbsp;&nbsp;&nbsp;{{ movie_api.runtime }}</p>
<div class="container bg-dark text-white p-4">
  <div class="row">
    <div class="col-sm-3">
      {% if movie_datab.poster_url %}
        <img src="{{ movie_datab.poster_url }}" alt="{{movie_datab.title}} poster" width="100%">
      {% else %}
        <img src="{% static 'images/document_missing.png' %}"  alt="{{movie_datab.title}} poster" width="100%">
      {% endif %}
    </div>
    <div class="col-md-5 col-sm-9">
      <p>Genre:
        {% for genre in movie_datab.genre %}
          <a href="#" class="badge bg-light text-dark">{{ genre }}</a>
        {% endfor %}
      </p>
      <p>Director:
        {% for director in movie_datab.director %}
          <a href="{% url 'person' director %}" class="badge bg-light text-dark">{{ director }}</a>
        {% endfor %}
      </p>
      <p>Actors:
        {% for actor in movie_datab.actors %}
          <a href="{% url 'person' actor %}" class="badge bg-light text-dark">{{ actor }}</a>
        {% endfor %}
      </p>
      <p>Released: {{ movie_api.released }}</p>
      <p>{{ movie_api.plot }}</p>
    </div>
    <!--only show those if user is logged in-->
    {% if user %}
      <div class="col-md-4 col-sm-12">
        <section style="float: right;">
          <a class="btn btn-outline-light btn-floating m-1 list-toggle-button" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% if is_favorites %}Remove from {% else %}Add to {% endif %}favorites" id="FA">
            <i class="fa-solid fa-heart" {% if is_favorites %} style="color: #208454;" {% endif %}></i>
          </a>
          <a class="btn btn-outline-light btn-floating m-1 list-toggle-button" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% if is_watched %}Remove from {% else %}Add to {% endif %}watched" id="WA">
            <i class="fa-solid fa-eye" {% if is_watched %} style="color: #208454;" {% endif %}></i>
          </a>
          <a class="btn btn-outline-light btn-floating m-1 list-toggle-button" data-bs-toggle="tooltip" data-bs-placement="bottom" title="{% if is_watchlist %}Remove from {% else %}Add to {% endif %}watchlist" id="LI">
            <i class="fa-solid fa-ticket" {% if is_watchlist %} style="color: #208454;" {% endif %}></i>
          </a>
        </section>
      </div>
    {% endif %}
  </div>
</div>

<h3 class="mt-5">Ratings</h3>
<div class="container bg-dark text-white p-4">
  <div class="d-flex justify-content-between">
    <div>
      <p class="d-inline ps-4" data-bs-toggle="tooltip" data-bs-placement="top" title="MSDB rating"> 
        {% if movie_datab.rating %}
          <span style="font-size: 2em;"> 
            <i class="fa-solid text-warning fa-star"></i> 
            {{ movie_datab.rating|floatformat }} 
          </span>
          Based on {{ movie_datab.review_count }} rating{% if movie_datab.review_count > 1 %}s{%endif%} 
          {% else %}Not yet rated by MSDB users{% endif %}
      </p>
    </div>
    {% if user %}
      <div class="pe-4">
        {% if user and not review%}
          <button id="add-review" class="btn btn-outline-light">Add review</button>
        {% endif %}
        {% if user and review %}
        <button id="edit-review" class="btn btn-outline-light">Edit review</button>
        {% endif %}
      </div>
    {% else %}
      <a href="{% url 'account_login' %}"class="btn btn-outline-light" data-bs-toggle="tooltip" data-bs-placement="top" title="Sign In to be able to add reviews">Add review</a>
    {% endif %}
  </div>
  {% include 'review_list_collapsable.html' with reviews=reviews review=review loop1=loop1 loop2=loop2%}
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content"></div>
  </div>
</div>

<div id="snackbar">Message</div>
<div id="snackbar_error">Message</div>

{% endblock content %}

{% block inline_javascript %}
<script>
    // getCookie Provided by Django in the Official Docs
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');

  $('.list-toggle-button').bind('click', function (e){
    e.preventDefault();
    const list_type = $(this).attr('id');
    const target = $(this)
    $.ajax({
      type: "POST",
      url: "{% url 'toggle_list' %}",
      data: {
        user_id: "{{ user.id }}",
        movie_id: "{{ movie_datab.id }}",
        list_type: list_type,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },

      success: function (response) {
        /*show and disappear snackbar*/
        var snackbar = document.getElementById("snackbar");
        snackbar.innerHTML = response.message;
        snackbar.className = "show";
        setTimeout(function(){ snackbar.className = snackbar.className.replace("show", ""); }, 3000);

        console.log("success")
        console.log(target)
        // action is either "add" or "remove"
        const response_action = response.action
        if(response_action === "add"){
          /*by all of them, update tooltip and change color to green*/
          /*by watchlist/watched - changing the other one to neutral color and changing the tooltip*/
          switch(list_type){
            case 'FA':
              target.attr('title', 'Remove from favorites');
              break;
            case 'LI':
              target.attr('title', 'Remove from watchlist');
              $("#WA").children().first().css("color","");
              $("#WA").attr('title', 'Add to watched');
              break;
            case 'WA':
              target.attr('title', 'Remove from watched');
              $("#LI").children().first().css("color","");
              $("#LI").attr('title', 'Add to watchlist');
              break;
          }
          target.children().first().css("color","#208454");
        }
        else if(response_action === "remove"){
          /*by all, update the color back to normal and update tooltip*/
          switch(list_type){
            case 'FA':
              target.attr('title', 'Add to favorites');
              break;
            case 'LI':
              target.attr('title', 'Add to watchlist');
              break;
            case 'WA':
              target.attr('title', 'Add to watched');
              break;
          }
          target.children().first().css("color","");
        }
      },
      error: function (response) {
        console.log("error")
        var snackbar = document.getElementById("snackbar_error");
        snackbar.innerHTML = "Unable to add to/remove from the list. ";
        snackbar.className = "show";
        setTimeout(function(){ snackbar.className = snackbar.className.replace("show", ""); }, 3000);
      }
    })
  });

  const user = "{{user}}"
  const review = "{{review}}"

  if (user != "None" && review == "None") {
    document.addEventListener('DOMContentLoaded', (e1) => {
      modalForm(document.getElementById('add-review'), {
        formURL: "{% url 'add_review' movie_datab.id %}"
      })
    });
  }
  if (user && review) {
    document.addEventListener('DOMContentLoaded', (e2) => {
      modalForm(document.getElementById('edit-review'), {
        formURL: "{% url 'edit_review' movie_datab.id %}"
      })
    });
  }
</script>
{% endblock inline_javascript %}
